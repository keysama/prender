!function(e){"function"==typeof define&&define.amd?define(e):e()}(function(){"use strict";const s=require("path"),r=require("url"),{prenderTag:i,cacheStore:a,cacheStoreMode:n,handleRenderToString:o,prenderLoadQueue:e}=require("../../constants"),{wait:c,createFile:l}=require("./tools");module.exports=class{constructor(e,t,i,o,a=s.join(__dirname,"./rebuild"),n=!1){this.browser=e,this.url=t,this.mode=i,this.pageOptions=o,this.rootPath=a,this.unitPath=r.parse(t).path.slice(1).replace("%20"," "),this.page=null,this.injectObj={mode:i,rootPath:this.rootPath,url:t,unitPath:this.unitPath},this.defaultWaitTime=5e3,this.debug=n}async start(){if(!this.browser)throw new Error("no puppeteer instence");try{console.log("===1==="),this.page=await this.browser.newPage(),console.log("===2==="),await this.filterRequest(),console.log("===3==="),await this.preInject(i,this.injectObj),console.log("===4==="),await this.page.goto(this.url,{...this.pageOptions,timeout:0}),console.log("===5==="),await c(this.defaultWaitTime),console.log("===6==="),this.cacheData=await this.collectRequest(),console.log("cached",this.cacheData);var e=(await this.digest(this.mode,this.cacheData))["computedFileData"];console.log("===8===");var t=await this.produce(e);return this.debug||(console.log("===9==="),await this.page.close()),t}catch(e){return console.log("==============error==============="),/TimeoutError/g.test(e.stack)?console.log("超时自动关闭，",this.url):console.log(e),console.log("=================================="),"error"}}async filterRequest(){this.page.on("request",e=>{const t=e.url();var i=e.url().split(".")[e.url().split(".").length-1];/(png|jpg|webp|woff2|woff|ttf|jpeg|svg|css)/g.test(i)||0<["pixlee_widget_1_0_0.js","heatmap.min.js","cdn1-sandbox.affirm.com","googleapis.com","mages.unsplash.com"].filter(e=>t.includes(e)).length?e.abort():e.continue()}),await this.page.setRequestInterception(!0)}async preInject(e,t){await this.page.evaluateOnNewDocument(`(function () { window['${e}'] = ${JSON.stringify(t)}; })();`)}async collectRequest(){return this.dataList=await this.page.evaluate((e,n)=>new Promise(a=>{0!==e&&setTimeout(()=>{a([])},e),function e(){if(!window[n]||0<window[n].size)console.log("===check==="),window.setTimeout(e,2e3);else{const t=[],i=document.querySelectorAll("[tag='PRERENDER_INJECTED']");for(let e=0;e<i.length;e++)t.push({origin_id:i[e].getAttribute("url"),id:i[e].id,data:JSON.parse(i[e].text),name:i[e].getAttribute("name"),type:i[e].getAttribute("type")});const o=document.getElementsByTagName("head")[0];for(let e=0;e<i.length;e++)o.removeChild(i[e]);a(t)}}()}),this.pageOptions.timeout,e),this.dataList}async digest(e,t){let i={},o=[];return o="inject"===e?(i=t.reduce((e,t)=>(e[t.id]=t.data,e),{}),[]):"json"===e?(i={},t.filter(e=>"env"===e.type||"parameter"===e.type)):(i=t.reduce((e,t)=>("env"==t.type&&(e[t.id]=t.data),e),{}),t.filter(e=>"parameter"===e.type)),await this.insertScript(a,i),await this.insertScript(n,e),{computedInjectData:i,computedFileData:o}}async reactReRender(e,t){return this.page.evaluate((i,o,a)=>new Promise(e=>{var t;window[a]?(console.log("handle===start"),t=window[a](i,o),console.log("handle===end"),document.getElementById("root").innerHTML=t,e()):console.log("no handle")}),e,t,o)}async produce(t){await this.reRenderCss(),await this.reRenderScripts();for(let e=0;e<t.length;e++)l(s.join(this.rootPath,"./jsons/"),t[e].id+".json",t[e].data);var e=await this.page.content(),i=JSON.stringify(t.map(e=>({origin_id:e.origin_id,id:e.id})));return await l(s.join(this.rootPath,this.unitPath,"./"),"index.html",e),await l(s.join(this.rootPath,this.unitPath,"./"),"dependent.json",i),t.length}async insertScript(e,t){return this.page.evaluate((e,t)=>{const i=document.createElement("script");i.type="text/javascript";t=`
              (function(){ 
                  window["${e}"] = ${JSON.stringify(t)}
                }
              )()
            `;i.appendChild(document.createTextNode(t)),document.getElementsByTagName("head")[0].appendChild(i)},e,t)}async reRenderCss(){return await this.page.evaluate(()=>new Promise(e=>{var t=function(){const t=[];for(let e=0;e<document.styleSheets.length;e++){var i=document.styleSheets[e];"style"===i.ownerNode.localName&&t.push(i)}return console.log("origin styleSheet:",t),t.map(t=>{const i={};let o="";for(let e=0;e<t.ownerNode.attributes.length;e++){var a=t.ownerNode.attributes[e];i[a.nodeName]=a.nodeValue}for(let e=0;e<t.rules.length;e++){var n=t.rules[e];o+=n?n.cssText:""}return{type:t.type,attributes:i,text:o?.trim()}})}();!function(){for(let e=document.head.getElementsByTagName("style").length-1;0<=e;e--)document.head.removeChild(document.head.getElementsByTagName("style")[e])}(),function(t){for(let e=0;e<t.length;e++){const i=t[e],o=document.createElement("style");o.type=i.type,Object.keys(i.attributes).forEach(e=>{i.attributes[e]?o.setAttribute(e,i.attributes[e]):(e=document.createAttribute(e),o.attributes.setNamedItem(e))}),o.appendChild(document.createTextNode(i.text)),document.head.append(o)}}(t),e(t)}))}async reRenderScripts(){return this.page.evaluate(()=>new Promise(e=>{const t=Array.prototype.filter.call(document.querySelectorAll("head script"),e=>e.src.includes("chunk"));t.reverse().forEach(e=>{document.body.insertBefore(e,document.getElementById("root").nextSibling)}),e()}))}}});
