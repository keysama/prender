!function(e){"function"==typeof define&&define.amd?define(e):e()}(function(){"use strict";const s=require("path"),r=require("url"),{prenderTag:i,cacheStore:o,cacheStoreMode:n,handleRenderToString:a,prenderLoadQueue:e}=require("../../constants"),{wait:c,createFile:l}=require("./tools");module.exports=class{constructor(e,t,a,i,o=s.join(__dirname,"./rebuild"),n=!1){this.browser=e,this.url=t,this.mode=a,this.pageOptions=i,this.rootPath=o,this.unitPath=r.parse(t).path.slice(1).replace("%20"," "),this.page=null,this.injectObj={mode:a,rootPath:this.rootPath,url:t,unitPath:this.unitPath},this.defaultWaitTime=5e3,this.debug=n}async start(){if(!this.browser)throw new Error("no puppeteer instence");try{console.log("===1==="),this.page=await this.browser.newPage(),console.log("===2==="),await this.filterRequest(),console.log("===3==="),await this.preInject(i,this.injectObj),console.log("===4==="),await this.page.goto(this.url,{...this.pageOptions,timeout:0}),console.log("===5==="),await c(this.defaultWaitTime),console.log("===6==="),this.cacheData=await this.collectRequest(),console.log("cached",this.cacheData);var{computedInjectData:e,computedFileData:t}=await this.digest(this.mode,this.cacheData);console.log("===7==="),await this.reactReRender(r.parse(this.url).pathname,e),console.log("===8===");var a=await this.produce(t);return this.debug||(console.log("===9==="),await this.page.close()),a}catch(e){return console.log("==============error==============="),/TimeoutError/g.test(e.stack)?console.log("超时自动关闭，",this.url):console.log(e),console.log("=================================="),"error"}}async filterRequest(){this.page.on("request",e=>{const t=e.url();var a=e.url().split(".")[e.url().split(".").length-1];/(png|jpg|webp|woff2|woff|ttf|jpeg|svg|css)/g.test(a)||0<["pixlee_widget_1_0_0.js","heatmap.min.js","cdn1-sandbox.affirm.com","googleapis.com","mages.unsplash.com"].filter(e=>t.includes(e)).length?e.abort():e.continue()}),await this.page.setRequestInterception(!0)}async preInject(e,t){await this.page.evaluateOnNewDocument(`(function () { window['${e}'] = ${JSON.stringify(t)}; })();`)}async collectRequest(){return this.dataList=await this.page.evaluate((e,n)=>new Promise(o=>{0!==e&&setTimeout(()=>{o([])},e),function e(){if(!window[n]||0<window[n].size)console.log("===check==="),window.setTimeout(e,2e3);else{const t=[],a=document.querySelectorAll("[tag='PRERENDER_INJECTED']");for(let e=0;e<a.length;e++)t.push({origin_id:a[e].getAttribute("url"),id:a[e].id,data:JSON.parse(a[e].text),name:a[e].getAttribute("name"),type:a[e].getAttribute("type")});const i=document.getElementsByTagName("head")[0];for(let e=0;e<a.length;e++)i.removeChild(a[e]);o(t)}}()}),this.pageOptions.timeout,e),this.dataList}async digest(e,t){let a={},i=[];return i="inject"===e?(a=t.reduce((e,t)=>(e[t.id]=t.data,e),{}),[]):"json"===e?(a={},t.filter(e=>"env"===e.type||"parameter"===e.type)):(a=t.reduce((e,t)=>("env"==t.type&&(e[t.id]=t.data),e),{}),t.filter(e=>"parameter"===e.type)),await this.insertScript(o,a),await this.insertScript(n,e),{computedInjectData:a,computedFileData:i}}async reactReRender(e,t){return this.page.evaluate((a,i,o)=>new Promise(e=>{var t;window[o]?(console.log("handle===start"),t=window[o](a,i),console.log("handle===end"),document.getElementById("root").innerHTML=t,e()):console.log("no handle")}),e,t,a)}async produce(t){await this.reRenderCss();for(let e=0;e<t.length;e++)l(s.join(this.rootPath,"./jsons/"),t[e].id+".json",t[e].data);var e=await this.page.content(),a=JSON.stringify(t.map(e=>({origin_id:e.origin_id,id:e.id})));return await l(s.join(this.rootPath,this.unitPath,"./"),"index.html",e),await l(s.join(this.rootPath,this.unitPath,"./"),"dependent.json",a),t.length}async insertScript(e,t){return this.page.evaluate((e,t)=>{const a=document.createElement("script");a.type="text/javascript";t=`
              (function(){ 
                  window["${e}"] = ${JSON.stringify(t)}
                }
              )()
            `;a.appendChild(document.createTextNode(t)),document.getElementsByTagName("head")[0].appendChild(a)},e,t)}async reRenderCss(){return await this.page.evaluate(()=>new Promise(e=>{var t=function(){const t=[];for(let e=0;e<document.styleSheets.length;e++){var a=document.styleSheets[e];"style"===a.ownerNode.localName&&t.push(a)}return t.map(e=>{const t={};let a="";return e.ownerNode.attributes.forEach(e=>{t[e.nodeName]=e.nodeValue}),e.rules.forEach(e=>{a+=e?e.cssText:""}),{type:e.type,attributes:t,text:a.trim()}})}();!function(){for(let e=document.head.getElementsByTagName("style").length-1;0<=e;e--)document.head.removeChild(document.head.getElementsByTagName("style")[e])}(),function(t){for(let e=0;e<t.length;e++){const a=t[e],i=document.createElement("style");i.type=a.type,Object.keys(a.attributes).forEach(e=>{a.attributes[e]?i.setAttribute(e,a.attributes[e]):(e=document.createAttribute(e),i.attributes.setNamedItem(e))}),i.appendChild(document.createTextNode(a.text)),document.head.append(i)}}(t),e(t)}))}}});
