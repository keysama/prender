{"version":3,"file":"prender.js","sources":["../../src/prender.js"],"sourcesContent":["const FlexCall = require(\"./flexCall\");\nconst Server = require(\"./server\");\nconst RerenderFactory = require(\"./rerenderFactory\");\n\nconst { \n    copyFile\n} = require(\"./tools\");\n\nclass Prender {\n    constructor({ routes, port, target, delta, output, show, incremental, exclude, timeout = 0, pool: syncNum = 5, debug }) {\n        this.routes = routes;\n        this.port = port;\n        this.target = target;\n        this.delta = delta;\n        this.output = output;\n        this.show = show;\n        this.incremental = incremental;\n        this.exclude = exclude;\n        this.syncNum = syncNum;\n        this.debug = debug;\n\n        this.puppeteerOptions = { headless: !show },\n            this.pageOptions = { waituntil: 'networkidle0', timeout: timeout },\n\n            this._server = new Server({\n                port,\n                staticPath: target\n            });\n        this._rerenderFactory = new RerenderFactory(\n            this.puppeteerOptions,\n            this.pageOptions,\n            { targetDir: delta, debug }\n        );\n    }\n\n    async start() {\n        await this._server.initialize();\n        await this._rerenderFactory.initialize();\n\n        const flex = new FlexCall(this.syncNum);\n\n        for (let i = 0; i < this.routes.length; i++) {\n            flex.push(async () => {\n                const item = this.routes[i];\n                const rerender = await this._rerenderFactory.create(`http://localhost:${this.port}${item.path}`, item.mode);\n                return rerender.start();\n            })\n        }\n\n        let results = await flex.run();\n\n        if (!this.debug) {\n            await this._rerenderFactory.close();\n            this._server.destroy();\n        } else {\n            console.log(\"finish rerender\")\n        }\n\n        try {\n            if (!this.incremental) {\n                copyFile(this.target, this.output, this.exclude)\n                copyFile(this.delta, this.output, this.exclude)\n            }\n        } catch (e) {\n\n        }\n\n        return results;\n\n    }\n\n}\n\n\nmodule.exports = Prender;"],"names":["FlexCall","require","Server","RerenderFactory","copyFile","Prender","constructor","routes","port","target","delta","output","show","incremental","exclude","timeout","pool","syncNum","debug","puppeteerOptions","headless","pageOptions","waituntil","_server","staticPath","_rerenderFactory","targetDir","start","initialize","flex","i","length","push","item","rerender","create","path","mode","results","run","close","destroy","console","log","e","module","exports"],"mappings":"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"}