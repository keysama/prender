!function(t){"function"==typeof define&&define.amd?define(t):t()}(function(){"use strict";const i=require("./flexCall"),c=require("./server"),p=require("./rerenderFactory"),r=require("path"),s=require("./tools")["copyFile"];module.exports=class{constructor({routes:t,port:e,target:i,delta:r,output:s,show:o,incremental:h,exclude:a,timeout:n=0,pool:u=5,debug:l}){this.routes=t,this.port=e,this.target=i,this.delta=r,this.output=s,this.show=o,this.incremental=h,this.exclude=a,this.syncNum=u,this.debug=l,this.puppeteerOptions={headless:!o,defaultViewport:{width:1600,height:900},args:["--disable-web-security"]},this.pageOptions={waituntil:"networkidle0",timeout:n},this._server=new c({port:e,staticPath:i}),this._rerenderFactory=new p(this.puppeteerOptions,this.pageOptions,{targetDir:r,debug:l})}async start(){await this._server.initialize(),await this._rerenderFactory.initialize();const t=new i(this.syncNum);for(let i=0;i<this.routes.length;i++)t.push(async()=>{var t=this.routes[i];const e=await this._rerenderFactory.create(`http://localhost:${this.port}${t.path}`,t.mode);return e.start()});var e=await t.run();this.debug?console.log("finish rerender"):(await this._rerenderFactory.close(),this._server.destroy());try{this.incremental||(s(this.target,this.output,this.exclude),this.routes?.find?.(t=>"/"===t.path)&&s(r.resolve(this.output,"./index.html"),r.resolve(this.output,"./base.html"),[]),s(this.delta,this.output,this.exclude))}catch(t){console.log(t)}return e}}});
