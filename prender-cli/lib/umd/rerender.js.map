{"version":3,"file":"rerender.js","sources":["../../src/rerender.js"],"sourcesContent":["const path = require('path');\nconst urlLib = require('url');\nconst {\n    prenderTag,\n    cacheStore,\n    cacheStoreMode,\n    handleRenderToString,\n    prenderLoadQueue\n} = require('../../constants');\n\nconst { \n    wait,\n    createFile\n} = require(\"./tools\");\n\nclass Rerender {\n    constructor(browser, url, mode, pageOptions, targetDir = path.join(__dirname, \"./rebuild\"), debug = false) {\n      this.browser = browser;\n      this.url = url;\n      this.mode = mode; // script json default:script\n      this.pageOptions = pageOptions;\n  \n      this.rootPath = targetDir;\n      this.unitPath = urlLib.parse(url).path.slice(1).replace(\"%20\",\" \");\n      this.page = null;\n      this.injectObj = { mode, rootPath: this.rootPath, url, unitPath: this.unitPath  };\n      this.defaultWaitTime = 5000;\n      this.debug = debug;\n      \n    }\n  \n    async start() {\n      if (!this.browser) {\n        throw new Error('no puppeteer instence');\n      }\n  \n      try{\n        this.page = await this.browser.newPage();\n  \n        await this.filterRequest();\n  \n        await this.preInject(prenderTag, this.injectObj);\n  \n        await this.page.goto(this.url, {...this.pageOptions, timeout : 0});\n  \n        await wait(this.defaultWaitTime);\n  \n        this.cacheData = await this.collectRequest();\n\n        console.log(\"cached\", this.cacheData)\n  \n        const { computedInjectData, computedFileData } = await this.digest(this.mode,this.cacheData);\n  \n        await this.reactReRender(urlLib.parse(this.url).pathname, computedInjectData);\n  \n        let dependentNum = await this.produce(computedFileData);\n  \n        if(!this.debug){\n          await this.page.close();\n        }\n  \n        return dependentNum;  \n  \n      }catch(e){\n        console.log(\"==============error===============\")\n        if(/TimeoutError/g.test(e.stack)){\n            console.log(\"超时自动关闭，\",this.url)\n        }else{\n            console.log(e)\n        }\n        console.log(\"==================================\")\n        await this.page.close();\n        return 'error';\n      }\n    }\n  \n    async filterRequest(){\n      this.page.on('request', (interceptedRequest) => {\n        const url = interceptedRequest.url();\n        const fileName = interceptedRequest.url().split('.')[\n          interceptedRequest.url().split('.').length - 1\n        ];\n  \n        const ignoreList = [\"pixlee_widget_1_0_0.js\",\"heatmap.min.js\",\"cdn1-sandbox.affirm.com\",\"googleapis.com\",\"mages.unsplash.com\"];\n  \n        if (/(png|jpg|webp|woff2|woff|ttf|jpeg|svg|css)/g.test(fileName)) {\n          interceptedRequest.abort(); // 终止请求\n        } else if(ignoreList.filter(item => url.includes(item)).length > 0){\n          interceptedRequest.abort(); \n        } else {\n          interceptedRequest.continue(); // 弹出\n        }\n      });\n  \n      await this.page.setRequestInterception(true);\n    }\n  \n    async preInject(name, data) {\n      await this.page.evaluateOnNewDocument(\n        `(function () { window['${name}'] = ${JSON.stringify(data)}; })();`\n      );\n    }\n  \n    async collectRequest() {\n      this.dataList = await this.page.evaluate(( timeout, prenderLoadQueue ) => {\n        return new Promise((resolve) => {\n          function check(){\n            if(!window[prenderLoadQueue] || window[prenderLoadQueue].size > 0){\n                console.log(\"===check===\")\n              window.setTimeout(check,500)\n            }else{\n              const arr = [];\n              const resources = document.querySelectorAll(\"[tag='PRERENDER_INJECTED']\");\n              for (let i = 0; i < resources.length; i++) {\n                arr.push({\n                  origin_id : resources[i].getAttribute('url'),\n                  id: resources[i].id,\n                  data: JSON.parse(resources[i].text),\n                  name: resources[i].getAttribute('name'),\n                  type: resources[i].getAttribute('type'),\n                });\n              }\n      \n              const head = document.getElementsByTagName('head')[0];\n          \n              for (let i = 0; i < resources.length; i++) {\n                head.removeChild(resources[i]);\n              }\n  \n              resolve(arr);\n            } \n          }\n  \n          if(timeout !== 0){\n            setTimeout(() => { resolve([]) } ,timeout)\n          }\n  \n          check();\n        });\n      }, this.pageOptions.timeout, prenderLoadQueue);\n  \n      return this.dataList;\n    }\n  \n    async digest(mode,data) {\n      let computedInjectData = {};\n      let computedFileData = [];\n  \n      if(mode === 'inject'){\n        computedInjectData = data.reduce((pre,next) => {\n          pre[next.id] = next.data;\n          return pre;\n        },{})\n        computedFileData = [];\n  \n      }else if(mode === 'json'){\n        computedInjectData = {}\n        computedFileData = data.filter(item => item.type === \"env\" || item.type === \"parameter\");\n  \n      }else{\n        computedInjectData = data.reduce((pre,next) => {\n          if(next.type == \"env\"){\n            pre[next.id] = next.data;\n          }\n          return pre;\n        },{})\n        computedFileData = data.filter(item => item.type === \"parameter\");\n      }\n  \n      await this.insertScript(cacheStore,computedInjectData)\n      await this.insertScript(cacheStoreMode,mode);\n  \n      return { computedInjectData,computedFileData };\n      \n    }\n  \n    async reactReRender(location, store){\n      return await this.page.evaluate((location, store, handleRenderToString) => {\n        return new Promise((resolve) => {\n          if(!window[handleRenderToString]){\n            console.log(\"no handle\")\n            return \n          }\n  \n          console.log(\"handle===start\")\n          const reactContent = window[handleRenderToString](location, store);\n          console.log(\"handle===end\")\n  \n  \n          document.getElementById('root').innerHTML = reactContent;\n          resolve();\n        });\n      }, location, store, handleRenderToString);\n    }\n  \n    async produce(jsons) {\n      await this.reRenderCss();\n  \n      for(let i = 0;i < jsons.length;i ++){\n        createFile(path.join(this.rootPath, \"./jsons/\"), jsons[i].id + \".json\",jsons[i].data);\n      }\n  \n      const content = await this.page.content(); // 获取内容\n      const dependent = JSON.stringify(jsons.map(item => ({\n            origin_id : item.origin_id,\n            id : item.id\n          })\n        )\n      );\n  \n      await createFile(path.join(this.rootPath,this.unitPath,\"./\"), 'index.html', content); // 生成html\n      await createFile(path.join(this.rootPath,this.unitPath,\"./\"), 'dependent.json', dependent);\n  \n      return jsons.length;\n    }\n  \n    async insertScript(name, data){\n      return await this.page.evaluate((name, data) => {\n        const scriptTag = document.createElement('script');\n        scriptTag.type = 'text/javascript';\n        const code = `\n              (function(){ \n                  window[\"${name}\"] = ${JSON.stringify(data)}\n                }\n              )()\n            `;\n        scriptTag.appendChild(document.createTextNode(code));\n        document.getElementsByTagName('head')[0].appendChild(scriptTag);\n      }, name, data);\n    }\n  \n    async reRenderCss() {\n      const styleSheetData = await this.page.evaluate(() => {\n        return new Promise((resolve) => {\n          function collectStyles() {\n            const styleSheets = [];\n            for (let i = 0; i < document.styleSheets.length; i++) {\n              const item = document.styleSheets[i];\n              item.ownerNode.localName === 'style' && styleSheets.push(item);\n            }\n  \n            return styleSheets.map((styleNode) => {\n              const attributes = {};\n              let text = '';\n  \n              styleNode.ownerNode.attributes.forEach((item) => {\n                attributes[item.nodeName] = item.nodeValue;\n              });\n  \n              styleNode.rules.forEach((item) => {\n                text += item ? item.cssText : '';\n              });\n  \n              return {\n                type: styleNode.type,\n                attributes,\n                text: text.trim(),\n              };\n            });\n          }\n  \n          function deleteStyles() {\n            for (\n              let i = document.head.getElementsByTagName('style').length - 1;\n              i >= 0;\n              i--\n            ) {\n              document.head.removeChild(document.head.getElementsByTagName('style')[i]);\n            }\n          }\n  \n          function createStyles(styles) {\n            for (let i = 0; i < styles.length; i++) {\n              const styleItem = styles[i];\n  \n              const styleTag = document.createElement('style');\n  \n              styleTag.type = styleItem.type;\n  \n              Object.keys(styleItem.attributes).forEach((attrname) => {\n                if (!styleItem.attributes[attrname]) {\n                  const attrItem = document.createAttribute(attrname);\n                  styleTag.attributes.setNamedItem(attrItem);\n                } else {\n                  styleTag.setAttribute(attrname, styleItem.attributes[attrname]);\n                }\n              });\n  \n              styleTag.appendChild(document.createTextNode(styleItem.text));\n  \n              document.head.append(styleTag);\n            }\n          }\n          const styleSheetData = collectStyles();\n          deleteStyles();\n          createStyles(styleSheetData);\n          resolve(styleSheetData);\n        });\n      });\n  \n      return styleSheetData;\n    }\n  \n  }\n\n  module.exports = Rerender;"],"names":["path","require","urlLib","prenderTag","cacheStore","cacheStoreMode","handleRenderToString","prenderLoadQueue","wait","createFile","Rerender","constructor","browser","url","mode","pageOptions","targetDir","join","__dirname","debug","rootPath","unitPath","parse","slice","replace","page","injectObj","defaultWaitTime","start","Error","newPage","filterRequest","preInject","goto","timeout","cacheData","collectRequest","console","log","computedInjectData","computedFileData","digest","reactReRender","pathname","dependentNum","produce","close","e","test","stack","on","interceptedRequest","fileName","split","length","ignoreList","abort","filter","item","includes","continue","setRequestInterception","name","data","evaluateOnNewDocument","JSON","stringify","dataList","evaluate","Promise","resolve","check","window","size","setTimeout","arr","resources","document","querySelectorAll","i","push","origin_id","getAttribute","id","text","type","head","getElementsByTagName","removeChild","reduce","pre","next","insertScript","location","store","reactContent","getElementById","innerHTML","jsons","reRenderCss","content","dependent","map","scriptTag","createElement","code","appendChild","createTextNode","styleSheetData","collectStyles","styleSheets","ownerNode","localName","styleNode","attributes","forEach","nodeName","nodeValue","rules","cssText","trim","deleteStyles","createStyles","styles","styleItem","styleTag","Object","keys","attrname","attrItem","createAttribute","setNamedItem","setAttribute","append","module","exports"],"mappings":"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"}